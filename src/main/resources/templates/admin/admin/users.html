<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Управление пользователями - Админ панель</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      background-color: #343a40;
      border-bottom: 3px solid #007bff;
    }

    .navbar-brand {
      color: white !important;
      font-weight: bold;
    }

    .container {
      margin-top: 30px;
    }

    .page-header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .page-title {
      color: #343a40;
      margin: 0;
    }

    .user-info {
      background-color: #e9ecef;
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .role-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .role-super-admin {
      background-color: #dc3545;
      color: white;
    }

    .role-editor {
      background-color: #fd7e14;
      color: white;
    }

    .role-viewer {
      background-color: #198754;
      color: white;
    }

    .role-none {
      background-color: #6c757d;
      color: white;
    }

    .users-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table thead th {
      background-color: #495057;
      color: white;
      border: none;
      padding: 15px;
    }

    .table tbody td {
      padding: 15px;
      vertical-align: middle;
      border-top: 1px solid #dee2e6;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.875rem;
    }

    .btn-group .btn {
      margin-right: 5px;
    }

    .btn-group .btn:last-child {
      margin-right: 0;
    }

    .alert {
      border: none;
      border-radius: 6px;
    }

    .no-users {
      text-align: center;
      padding: 50px;
      color: #6c757d;
    }

    .breadcrumb {
      background-color: transparent;
      padding: 0;
      margin-bottom: 20px;
    }

    .breadcrumb-item a {
      color: #007bff;
      text-decoration: none;
    }

    .breadcrumb-item.active {
      color: #6c757d;
    }

    .actions-column {
      min-width: 200px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .create-user-btn {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
    }

    .create-user-btn:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
  </style>
</head>
<body>
<!-- Навигация -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="/admin">
      <i class="fas fa-shield-alt me-2"></i>Админ панель
    </a>
    <div class="navbar-nav ms-auto">
                <span class="navbar-text text-light" th:if="${currentUser}">
                    <i class="fas fa-user me-1"></i>
                    <span th:text="${currentUser.username}">admin</span>
                    <span class="role-badge ms-2"
                          th:classappend="${currentUser.adminType.name() == 'SUPER_ADMIN'} ? 'role-super-admin' :
                                         (${currentUser.adminType.name() == 'EDITOR'} ? 'role-editor' :
                                         (${currentUser.adminType.name() == 'VIEWER'} ? 'role-viewer' : 'role-none'))"
                          th:text="${currentUser.adminType.displayName}">
                        Полный доступ
                    </span>
                </span>
      <a href="/admin/logout" class="btn btn-outline-light btn-sm ms-3">
        <i class="fas fa-sign-out-alt me-1"></i>Выйти
      </a>
    </div>
  </div>
</nav>

<div class="container">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-home"></i> Главная</a></li>
      <li class="breadcrumb-item active" aria-current="page">Пользователи</li>
    </ol>
  </nav>

  <!-- Заголовок страницы -->
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="page-title">
          <i class="fas fa-users me-2"></i>Управление пользователями
        </h1>
        <p class="text-muted mb-0">Просмотр и управление административными пользователями</p>
      </div>
      <div th:if="${currentUser.adminType.name() == 'SUPER_ADMIN'}">
        <a href="/admin/create-user" class="btn create-user-btn">
          <i class="fas fa-user-plus me-2"></i>Добавить пользователя
        </a>
      </div>
    </div>
  </div>

  <!-- Сообщения -->
  <div class="alert alert-danger" th:if="${error}">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span th:text="${error}">Ошибка</span>
  </div>

  <div class="alert alert-success" th:if="${success}">
    <i class="fas fa-check-circle me-2"></i>
    <span th:text="${success}">Успех</span>
  </div>

  <!-- Таблица пользователей -->
  <div class="users-table">
    <div th:if="${users != null and !users.empty}">
      <table class="table table-hover mb-0">
        <thead>
        <tr>
          <th>Пользователь</th>
          <th>Имя пользователя</th>
          <th>Роль</th>
          <th>Дата создания</th>
          <th class="actions-column">Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${users}">
          <td>
            <div class="d-flex align-items-center">
              <div class="user-avatar me-3" th:text="${#strings.substring(user.username, 0, 1).toUpperCase()}">A</div>
              <div>
                <div class="fw-bold" th:text="${user.username}">admin</div>
                <small class="text-muted">ID: <span th:text="${user.id}">1</span></small>
              </div>
            </div>
          </td>
          <td>
            <span th:text="${user.username}">admin</span>
          </td>
          <td>
                                <span class="role-badge"
                                      th:classappend="${user.adminType.name() == 'SUPER_ADMIN'} ? 'role-super-admin' :
                                                     (${user.adminType.name() == 'EDITOR'} ? 'role-editor' :
                                                     (${user.adminType.name() == 'VIEWER'} ? 'role-viewer' : 'role-none'))"
                                      th:text="${user.adminType.displayName}">
                                    Полный доступ
                                </span>
          </td>
          <td>
            <span th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}" th:if="${user.createdAt}">01.01.2024 12:00</span>
            <span th:unless="${user.createdAt}" class="text-muted">Не указана</span>
          </td>
          <td>
            <div class="btn-group">
              <!-- Просмотр (все роли) -->
              <a th:href="@{'/admin/user/' + ${user.id}}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye"></i> Просмотр
              </a>

              <!-- Редактирование (EDITOR и SUPER_ADMIN) -->
              <a th:if="${currentUser.adminType.name() == 'EDITOR' or currentUser.adminType.name() == 'SUPER_ADMIN'}"
                 th:href="@{'/admin/user/' + ${user.id} + '/edit'}"
                 class="btn btn-outline-warning btn-sm">
                <i class="fas fa-edit"></i> Изменить
              </a>

              <!-- Удаление (только SUPER_ADMIN и не себя) -->
              <button th:if="${currentUser.adminType.name() == 'SUPER_ADMIN' and user.id != currentUser.id}"
                      type="button"
                      class="btn btn-outline-danger btn-sm"
                      onclick="confirmDelete(this)"
                      th:data-user-id="${user.id}"
                      th:data-username="${user.username}">
                <i class="fas fa-trash"></i> Удалить
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Сообщение об отсутствии пользователей -->
    <div th:if="${users == null or users.empty}" class="no-users">
      <i class="fas fa-users fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">Пользователи не найдены</h4>
      <p class="text-muted">В системе пока нет зарегистрированных пользователей.</p>
      <a href="/admin/create-user" class="btn create-user-btn" th:if="${currentUser.adminType.name() == 'SUPER_ADMIN'}">
        <i class="fas fa-user-plus me-2"></i>Создать первого пользователя
      </a>
    </div>
  </div>

  <!-- Статистика -->
  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Всего пользователей</h5>
          <h2 class="text-primary" th:text="${users != null ? users.size() : 0}">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Администраторы</h5>
          <h2 class="text-success" th:text="${users != null ? users.stream().filter(u -> u.adminType.name() != 'NONE').count() : 0}">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title">Супер-админы</h5>
          <h2 class="text-danger" th:text="${users != null ? users.stream().filter(u -> u.adminType.name() == 'SUPER_ADMIN').count() : 0}">0</h2>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-danger me-2"></i>
          Подтверждение удаления
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Вы действительно хотите удалить пользователя <strong id="deleteUsername"></strong>?</p>
        <div class="alert alert-warning">
          <i class="fas fa-warning me-2"></i>
          Это действие нельзя отменить!
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <form id="deleteForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-2"></i>Удалить
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script>
  // Автоматическое скрытие алертов через 5 секунд
  setTimeout(function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      alert.style.transition = 'opacity 0.5s';
      alert.style.opacity = '0';
      setTimeout(() => alert.remove(), 500);
    });
  }, 5000);

  // Подтверждение удаления
  function confirmDelete(button) {
    const userId = button.getAttribute('data-user-id');
    const username = button.getAttribute('data-username');

    document.getElementById('deleteUsername').textContent = username;
    document.getElementById('deleteForm').action = '/admin/user/' + userId + '/delete';

    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
  }
</script>
</body>
</html>