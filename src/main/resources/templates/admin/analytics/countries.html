<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика по странам - Аналитика</title>
</head>
<body>

<h1>Аналитика по странам</h1>

<!-- Навигация -->
<p>
    <a href="/analytics">← Назад к аналитике</a> |
    <a href="/analytics/ip">Поиск по IP</a> |
    <a href="/analytics/top-ips">Топ IP</a> |
    <a href="/analytics/visitors">Все посетители</a>
</p>

<hr>

<!-- Селектор периода -->
<h2>Период анализа</h2>
<p>
    <strong>Показать данные за:</strong>
    <a th:href="@{/analytics/countries(days=1)}"
       th:style="${selectedDays == 1} ? 'font-weight: bold; color: blue;' : ''">1 день</a> |
    <a th:href="@{/analytics/countries(days=7)}"
       th:style="${selectedDays == 7} ? 'font-weight: bold; color: blue;' : ''">7 дней</a> |
    <a th:href="@{/analytics/countries(days=30)}"
       th:style="${selectedDays == 30} ? 'font-weight: bold; color: blue;' : ''">30 дней</a> |
    <a th:href="@{/analytics/countries(days=90)}"
       th:style="${selectedDays == 90} ? 'font-weight: bold; color: blue;' : ''">90 дней</a>
</p>

<hr>

<!-- Общая статистика -->
<h2>Общая статистика за <span th:text="${selectedDays}">7</span> дней</h2>
<table border="1" cellpadding="5">
    <tr>
        <td><strong>Всего посещений:</strong></td>
        <td th:text="${totalVisits}">123</td>
    </tr>
    <tr>
        <td><strong>Уникальных стран:</strong></td>
        <td th:text="${#lists.size(countriesStats)}">8</td>
    </tr>
    <tr>
        <td><strong>Среднее посещений на страну:</strong></td>
        <td th:text="${#lists.size(countriesStats) > 0 ? #numbers.formatDecimal(totalVisits / #lists.size(countriesStats), 1, 1) : 0}">15.4</td>
    </tr>
</table>

<hr>

<!-- Статистика по странам -->
<h2>Детальная статистика по странам</h2>

<div th:if="${countriesStats != null and !countriesStats.isEmpty()}">
    <p><strong>Найдено стран:</strong> <span th:text="${#lists.size(countriesStats)}">8</span></p>

    <!-- Топ 3 страны - выделенно -->
    <h3>🏆 Топ 3 страны</h3>
    <table border="2" cellpadding="10" width="100%" th:if="${#lists.size(countriesStats) >= 3}">
        <thead>
        <tr style="background-color: #f0f0f0;">
            <th>🥇🥈🥉 Место</th>
            <th>🌍 Страна</th>
            <th>📊 Посещений</th>
            <th>📈 % от общего</th>
            <th>🔍 Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="country, countryStat : ${countriesStats}" th:if="${countryStat.count <= 3}">
            <td style="text-align: center;">
                <strong>
                    <span th:if="${countryStat.count == 1}">🥇 1</span>
                    <span th:if="${countryStat.count == 2}">🥈 2</span>
                    <span th:if="${countryStat.count == 3}">🥉 3</span>
                </strong>
            </td>
            <td>
                <strong th:text="${country[0] ?: 'Невідома країна'}">Ukraine</strong>
                <br>
                <small style="color: gray;">
                            <span th:switch="${country[0]}">
                                <span th:case="'Ukraine'">🇺🇦</span>
                                <span th:case="'Poland'">🇵🇱</span>
                                <span th:case="'Germany'">🇩🇪</span>
                                <span th:case="'United States'">🇺🇸</span>
                                <span th:case="'Canada'">🇨🇦</span>
                                <span th:case="'France'">🇫🇷</span>
                                <span th:case="'United Kingdom'">🇬🇧</span>
                                <span th:case="'Italy'">🇮🇹</span>
                                <span th:case="'Spain'">🇪🇸</span>
                                <span th:case="'Netherlands'">🇳🇱</span>
                                <span th:case="*">🌍</span>
                            </span>
                </small>
            </td>
            <td style="text-align: center;">
                <strong style="font-size: 1.2em;" th:text="${country[1]}">150</strong>
            </td>
            <td style="text-align: center;">
                <strong th:text="${#numbers.formatDecimal((country[1] * 100.0 / totalVisits), 1, 1)} + '%'">60.5%</strong>
            </td>
            <td style="text-align: center;">
                <a href="#">📊 Детали</a>
            </td>
        </tr>
        </tbody>
    </table>

    <hr>

    <!-- Полный список стран -->
    <h3>📋 Полный список всех стран</h3>
    <table border="1" cellpadding="5" width="100%">
        <thead>
        <tr style="background-color: #f9f9f9;">
            <th width="10%">#</th>
            <th width="10%">Флаг</th>
            <th width="30%">Страна</th>
            <th width="20%">Посещений</th>
            <th width="20%">% от общего</th>
            <th width="10%">График</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="country, countryStat : ${countriesStats}">
            <td style="text-align: center;">
                <strong th:text="${countryStat.count}">1</strong>
            </td>
            <td style="text-align: center; font-size: 1.5em;">
                        <span th:switch="${country[0]}">
                            <span th:case="'Ukraine'">🇺🇦</span>
                            <span th:case="'Poland'">🇵🇱</span>
                            <span th:case="'Germany'">🇩🇪</span>
                            <span th:case="'United States'">🇺🇸</span>
                            <span th:case="'Canada'">🇨🇦</span>
                            <span th:case="'France'">🇫🇷</span>
                            <span th:case="'United Kingdom'">🇬🇧</span>
                            <span th:case="'Italy'">🇮🇹</span>
                            <span th:case="'Spain'">🇪🇸</span>
                            <span th:case="'Netherlands'">🇳🇱</span>
                            <span th:case="'Austria'">🇦🇹</span>
                            <span th:case="'Belgium'">🇧🇪</span>
                            <span th:case="'Czech Republic'">🇨🇿</span>
                            <span th:case="'Denmark'">🇩🇰</span>
                            <span th:case="'Finland'">🇫🇮</span>
                            <span th:case="'Norway'">🇳🇴</span>
                            <span th:case="'Sweden'">🇸🇪</span>
                            <span th:case="'Switzerland'">🇨🇭</span>
                            <span th:case="*">🌍</span>
                        </span>
            </td>
            <td>
                <strong th:text="${country[0] ?: 'Невідома країна'}">Ukraine</strong>
            </td>
            <td style="text-align: center;">
                <strong th:text="${country[1]}">150</strong>
            </td>
            <td style="text-align: center;">
                <span th:text="${#numbers.formatDecimal((country[1] * 100.0 / totalVisits), 1, 1)} + '%'">60.5%</span>
            </td>
            <td>
                <!-- Простой текстовый график -->
                <div style="background-color: #e0e0e0; width: 100%; height: 20px; position: relative;">
                    <div th:style="'background-color: #4CAF50; height: 20px; width: ' + ${country[1] * 100.0 / totalVisits} + '%;'"></div>
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <hr>

    <!-- Дополнительная аналитика -->
    <h3>📊 Дополнительная аналитика</h3>
    <table border="1" cellpadding="5">
        <tr>
            <td><strong>Самая активная страна:</strong></td>
            <td>
                <strong th:text="${countriesStats[0][0]}">Ukraine</strong>
                (<span th:text="${countriesStats[0][1]}">150</span> посещений -
                <span th:text="${#numbers.formatDecimal((countriesStats[0][1] * 100.0 / totalVisits), 1, 1)} + '%'">60%</span>)
            </td>
        </tr>
        <tr>
            <td><strong>Всего стран:</strong></td>
            <td>
                <span th:text="${#lists.size(countriesStats)}">8</span> стран
            </td>
        </tr>
        <tr>
            <td><strong>Средние посещения на страну:</strong></td>
            <td>
                <span th:text="${#numbers.formatDecimal(totalVisits / #lists.size(countriesStats), 1, 1)}">18.7</span> посещений
            </td>
        </tr>
        <tr>
            <td><strong>Доминирование лидера:</strong></td>
            <td>
                <span th:text="${#numbers.formatDecimal((countriesStats[0][1] * 100.0 / totalVisits), 1, 1)} + '%'">60%</span>
                от всех посещений
            </td>
        </tr>
    </table>

</div>

<!-- Нет данных -->
<div th:if="${countriesStats == null or countriesStats.isEmpty()}">
    <h3 style="color: orange;">🚫 Нет данных по странам</h3>
    <p>За выбранный период <strong th:text="${selectedDays}">7</strong> дней не было посещений из определенных стран.</p>
    <p>Возможные причины:</p>
    <ul>
        <li>Период слишком короткий</li>
        <li>Проблемы с определением геолокации</li>
        <li>Система трекинга была отключена</li>
    </ul>
    <p>
        <a href="/analytics/countries?days=30">Попробуйте период 30 дней</a> |
        <a href="/analytics">Вернуться к главной аналитике</a>
    </p>
</div>

<!-- Ошибки -->
<div th:if="${error}" style="color: red; border: 2px solid red; padding: 15px; margin: 10px 0; background-color: #ffe6e6;">
    <h3>❌ Ошибка</h3>
    <p th:text="${error}">Произошла ошибка загрузки</p>
    <p><a href="/analytics">← Вернуться к главной аналитике</a></p>
</div>

<hr>

<!-- Быстрые действия -->
<h3>🚀 Быстрые действия</h3>
<ul>
    <li>
        <a href="/analytics/ip">🔍 Найти конкретный IP адрес</a>
    </li>
    <li>
        <a href="/analytics/top-ips">👥 Посмотреть топ IP адресов</a>
    </li>
    <li>
        <a href="/analytics/visitors">📄 Все посетители</a>
    </li>
    <li>
        <a href="/analytics">📈 Общая аналитика</a>
    </li>
</ul>

<hr>

<!-- Пояснения -->
<h3>ℹ️ Пояснения</h3>
<ul>
    <li><strong>Страна</strong> - определяется по IP адресу посетителя</li>
    <li><strong>Посещения</strong> - количество страниц, просмотренных из данной страны</li>
    <li><strong>% от общего</strong> - доля посещений от общего количества за период</li>
    <li><strong>График</strong> - визуальное представление доли страны</li>
</ul>

<hr>

<p>
    <small>
        <a href="/analytics">← Вернуться к главной аналитике</a>
    </small>
</p>

</body>
</html>