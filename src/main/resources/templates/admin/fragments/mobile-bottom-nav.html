<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
</head>
<body>

<!-- Mobile Bottom Navigation Fragment -->
<div class="mobile-bottom-nav" id="mobileBottomNav" th:fragment="mobile-bottom-navigation">
  <ul class="mobile-bottom-nav-list">
    <!-- Главная -->
    <li class="mobile-bottom-nav-item">
      <a th:href="@{/}"
         class="mobile-bottom-nav-link"
         th:classappend="${currentURI == '/' ? 'active' : ''}">
        <i class="fas fa-home mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Головна</span>
      </a>
    </li>


    <!-- Товары -->
    <li class="mobile-bottom-nav-item">
      <a th:href="@{/product/all}"
         class="mobile-bottom-nav-link"
         th:classappend="${#strings.startsWith(currentURI, '/product/all') ? 'active' : ''}">
        <i class="fas fa-th-large mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Товари</span>
      </a>
    </li>



    <!-- Категории с выпадающим меню -->
    <li class="mobile-bottom-nav-item mobile-categories-item">
      <!-- Изменяем на кнопку без href -->
      <button type="button"
              class="mobile-bottom-nav-link mobile-categories-trigger"
              th:classappend="${currentURI == '/categories' or #strings.startsWith(currentURI, '/categories/') ? 'active' : ''}"
              data-toggle="categories">
        <i class="fas fa-list mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Категорії</span>
        <!-- Показываем стрелку только если есть категории -->
        <i class="fas fa-chevron-up mobile-categories-arrow"
           th:if="${navigationCategories != null and #lists.size(navigationCategories) > 0}"></i>
      </button>

      <!-- Выпадающее меню категорий -->
      <div class="mobile-categories-dropdown"
           th:if="${navigationCategories != null and #lists.size(navigationCategories) > 0}">
        <div class="mobile-categories-list">
          <!-- Ссылка "Все категории" -->
          <a th:href="@{/categories}"
             class="mobile-category-link"
             th:classappend="${currentURI == '/categories' ? 'active' : ''}">
            <i class="fas fa-th-large mobile-category-icon"></i>
            <span class="mobile-category-name">Всі категорії</span>
          </a>

          <!-- Динамические категории из базы данных -->
          <a th:each="category : ${navigationCategories}"
             th:href="@{'/categories/' + ${category.slug}}"
             class="mobile-category-link"
             th:classappend="${#strings.contains(currentURI, category.slug) ? 'active' : ''}">
            <i class="fas fa-layer-group mobile-category-icon"></i>
            <span class="mobile-category-name" th:text="${category.name}">Category Name</span>
          </a>
        </div>
      </div>
    </li>


    <!-- ПОИСК (простая ссылка) -->
    <li class="mobile-bottom-nav-item">
      <a th:href="@{/search}"
         class="mobile-bottom-nav-link"
         th:classappend="${currentURI == '/search' ? 'active' : ''}">
        <i class="fas fa-search mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Пошук</span>
      </a>
    </li>


    <!-- ИЗБРАННОЕ -->
    <li class="mobile-bottom-nav-item">
      <a th:href="@{/wishlist}"
         class="mobile-bottom-nav-link"
         th:classappend="${currentURI == '/wishlist' ? 'active' : ''}">
        <i class="fas fa-heart mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Вибране</span>
        <span class="mobile-nav-badge favorites"
              th:if="${favoritesCount > 0}"
              th:text="${favoritesCount}">0</span>
      </a>
    </li>

    <!-- Корзина -->
    <li class="mobile-bottom-nav-item">
      <a th:href="@{/cart}"
         class="mobile-bottom-nav-link"
         th:classappend="${currentURI == '/cart' ? 'active' : ''}">
        <i class="fas fa-shopping-bag mobile-bottom-nav-icon"></i>
        <span class="mobile-bottom-nav-text">Кошик</span>
        <span class="mobile-nav-badge"
              th:if="${cartCount > 0}"
              th:text="${cartCount}">0</span>
      </a>
    </li>
  </ul>
</div>

<!-- Mobile Bottom Navigation JavaScript -->
<script th:fragment="mobile-bottom-navigation-script">
  document.addEventListener('DOMContentLoaded', function() {
    // Базовая функциональность навигации (исключаем кнопку категорий)
    const bottomNavLinks = document.querySelectorAll('.mobile-bottom-nav-link:not(.mobile-categories-trigger)');

    if (bottomNavLinks.length > 0) {
      bottomNavLinks.forEach(link => {
        // Тактильная обратная связь при клике
        link.addEventListener('click', function() {
          this.style.transform = 'scale(0.95)';
          setTimeout(() => {
            this.style.transform = 'scale(1)';
          }, 150);
        });

        // Анимация иконок при наведении
        const icon = link.querySelector('.mobile-bottom-nav-icon');
        if (icon) {
          link.addEventListener('mouseenter', function() {
            if (window.innerWidth <= 991) {
              icon.style.transform = 'translateY(-2px) scale(1.1)';
            }
          });

          link.addEventListener('mouseleave', function() {
            if (window.innerWidth <= 991) {
              icon.style.transform = 'translateY(0) scale(1)';
            }
          });
        }
      });
    }

    // Функциональность выпадающего меню категорий
    const categoriesTrigger = document.querySelector('.mobile-categories-trigger');
    const categoriesDropdown = document.querySelector('.mobile-categories-dropdown');
    const categoriesArrow = document.querySelector('.mobile-categories-arrow');

    if (categoriesTrigger && categoriesDropdown) {
      // НОВАЯ ЛОГИКА: любой клик на кнопку категорий открывает/закрывает меню
      categoriesTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Тактильная обратная связь
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 150);

        // Переключаем выпадающее меню
        toggleCategoriesDropdown();
      });

      // Функция переключения выпадающего меню
      function toggleCategoriesDropdown() {
        const isOpen = categoriesDropdown.classList.contains('show');

        if (isOpen) {
          // Закрываем меню
          categoriesDropdown.classList.remove('show');
          if (categoriesArrow) {
            categoriesArrow.style.transform = 'rotate(0deg)';
          }
          categoriesTrigger.classList.remove('dropdown-open');
        } else {
          // Открываем меню
          categoriesDropdown.classList.add('show');
          if (categoriesArrow) {
            categoriesArrow.style.transform = 'rotate(180deg)';
          }
          categoriesTrigger.classList.add('dropdown-open');
        }
      }

      // Закрываем меню при клике вне его
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.mobile-categories-item')) {
          categoriesDropdown.classList.remove('show');
          if (categoriesArrow) {
            categoriesArrow.style.transform = 'rotate(0deg)';
          }
          categoriesTrigger.classList.remove('dropdown-open');
        }
      });

      // Закрываем меню при клике на любую ссылку категории
      const categoryLinks = document.querySelectorAll('.mobile-category-link');
      categoryLinks.forEach(link => {
        link.addEventListener('click', function() {
          // Закрываем выпадающее меню при переходе
          categoriesDropdown.classList.remove('show');
          if (categoriesArrow) {
            categoriesArrow.style.transform = 'rotate(0deg)';
          }
          categoriesTrigger.classList.remove('dropdown-open');
        });
      });
    }

    // Автоскрытие навигации при скролле
    let lastScrollTop = 0;
    const bottomNav = document.getElementById('mobileBottomNav');

    if (bottomNav && window.innerWidth <= 991) {
      window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (scrollTop > lastScrollTop && scrollTop > 100) {
          // Скролл вниз - скрываем навигацию
          bottomNav.style.transform = 'translateY(100%)';
          // Закрываем выпадающее меню при скролле
          if (categoriesDropdown) {
            categoriesDropdown.classList.remove('show');
            if (categoriesArrow) {
              categoriesArrow.style.transform = 'rotate(0deg)';
            }
            if (categoriesTrigger) {
              categoriesTrigger.classList.remove('dropdown-open');
            }
          }
        } else {
          // Скролл вверх - показываем навигацию
          bottomNav.style.transform = 'translateY(0)';
        }

        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
      }, { passive: true });
    }

    // Обновление счетчиков
    function updateBottomNavBadges(cartCount, favoritesCount) {
      const cartBadge = document.querySelector('.mobile-bottom-nav .mobile-nav-badge:not(.favorites)');
      const favoritesBadge = document.querySelector('.mobile-bottom-nav .mobile-nav-badge.favorites');

      if (cartBadge) {
        if (cartCount > 0) {
          cartBadge.textContent = cartCount;
          cartBadge.style.display = 'flex';
        } else {
          cartBadge.style.display = 'none';
        }
      }

      if (favoritesBadge) {
        if (favoritesCount > 0) {
          favoritesBadge.textContent = favoritesCount;
          favoritesBadge.style.display = 'flex';
        } else {
          favoritesBadge.style.display = 'none';
        }
      }
    }

    // Экспортируем функцию для использования в других скриптах
    window.updateBottomNavBadges = updateBottomNavBadges;

    // Дебаг информация
    console.log('Mobile navigation initialized');
    console.log('Categories found:', document.querySelectorAll('.mobile-category-link').length - 1);
  });
</script>

</body>
</html>